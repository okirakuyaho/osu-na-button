<script>
  // ====== CONFIG ======
  const API_URL = "https://script.google.com/macros/s/AKfycbysugL48aqY2gU3efpKmJEVMoLBir6kQUO5UGKCTkPaX04zrAXf04id4Ok512tbn5vM/exec";

  // ====== state & elements ======
  const el = {
    total: document.getElementById('total'),
    local: document.getElementById('local'),
    visitors: document.getElementById('visitors'),
    next: document.getElementById('next'),
    entry: document.getElementById('entry'),
    btn: document.getElementById('pushBtn'),
    toast: document.getElementById('toast'),
  };
  let localClicks = 0;
  let cooldown = false;

  // ====== helpers ======
  const fmt2 = n => String(n).padStart(2,'0');
  const nowStr = () => {
    const d = new Date();
    return `${d.getFullYear()}-${fmt2(d.getMonth()+1)}-${fmt2(d.getDate())} ${fmt2(d.getHours())}:${fmt2(d.getMinutes())}`;
  };
  const toast = (msg) => {
    el.toast.textContent = msg;
    el.toast.style.display = 'block';
    setTimeout(()=> el.toast.style.display = 'none', 1200);
  };
  const genVisitorId = () => {
    if (window.crypto?.getRandomValues) {
      const a = new Uint8Array(16);
      crypto.getRandomValues(a);
      return 'v-' + Array.from(a).map(b=>b.toString(16).padStart(2,'0')).join('');
    }
    return 'v-' + Math.random().toString(16).slice(2) + Date.now().toString(16);
  };
  const getVisitorId = () => {
    const KEY = 'osu_na_visitor_id';
    let id = localStorage.getItem(KEY);
    if (!id){ id = genVisitorId(); localStorage.setItem(KEY, id); }
    return id;
  };

  // ====== API（CORS回避のGET版） ======
  const api = async (action, payload = {}) => {
    const qs = new URLSearchParams({ action, ...payload });
    const url = `${API_URL}?${qs.toString()}`;
    const res = await fetch(url, { method: 'GET', cache: 'no-store' });
    if (!res.ok) throw new Error(`API ${res.status}`);
    return res.json();
  };

  const refresh = async () => {
    const data = await api('getData');
    if (!data.ok) return;
    el.total.textContent = data.click_total;
    el.visitors.textContent = data.visitors_total;
    el.next.textContent = `Next: ${data.next_threshold} ▶︎ 1`;
  };

  const init = async () => {
    // entry time (session basis)
    el.entry.textContent = nowStr();

    // register / update visitor
    const vid = getVisitorId();
    await api('enter', { visitor_id: vid });

    // initial numbers
    await refresh();

    // button
    el.btn.addEventListener('click', async () => {
      if (cooldown) return;
      cooldown = true;
      el.btn.disabled = true;

      try{
        const res = await api('addClick');
        if (res.ok){
          // global
          el.total.textContent = res.click_total;
          // local (session only)
          localClicks += 1; el.local.textContent = localClicks;

          if (res.milestone){
            toast(`${res.milestone.jp} / ${res.milestone.en}`);
            await refresh(); // hint 更新
          }
        }
      }catch(e){
        console.error(e);
        toast('Error');
      }finally{
        setTimeout(()=>{ cooldown=false; el.btn.disabled = false; }, 200);
      }
    });
  };

  init();
</script>
